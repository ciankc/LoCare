<!DOCTYPE html>
<html>

<head>
  <title>Locare</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <link rel="stylesheet" href="stylesheets/style.css">
  <link rel="stylesheet" href="https://bootswatch.com/4/materia/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <img src="/images/logo.png" style="height: 50px; width: 50px;" onclick="toggleNav()">
    <div class="container-fluid">
      <h1 class=" navbar-brand" id="sideBar">Welcome to LoCare</h1>
    </div>
  </nav>

  <div id="mySidenav" class="sidenav">
    <br>
    <br>
    <br>
    <br>
    <h2>
      <span style="color: white">
        Enter a unique id to get started!
      </span>
    </h2>
    <br>
    <br>
    <input id="pac-input" class="controls" type="text" placeholder="Search unique ID">
    <br>
    <br>
    <input type="button" id="searchBtn" value="Search" onclick="deleteMarkers(); handleInput(''); restartPeriodicUpdates();"
      class="btn btn-primary" />
    <br>
    <br>
    <input type="button" id="stopPeriodicUpdates" value="Stop Periodic Updates" onclick="stopPeriodicUpdates();" class="btn btn-warning"
    />
    <br>
    <br>
    <input type="button" id="restartPeriodicUpdates" value="Restart Periodic Updates" onclick="restartPeriodicUpdates();" class="btn btn-warning"
    />
    <!-- <input type="button" id="postBtn" value="Post New Data" onclick="postStuff();" /> -->
    <br>
    <br>
    <input type="button" id="deleteBtn" value="Delete All Data" onclick="deleteAllData();" class="btn btn-danger" />
  </div>

  <div class="main">
    <div id="map"></div>
  </div>

  <script>
    var navCount = 0;
    function toggleNav() {
      if (navCount % 2 == 0) {
        document.getElementById("mySidenav").style.width = "250px";
      }
      else {
        document.getElementById("mySidenav").style.width = "0";
      }
      navCount++;
    }

    $("#pac-input").keyup(function (event) {
      if (event.keyCode === 13) {
        $("#searchBtn").click();
      }
    });

    var map;
    var markers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 34.0522, lng: -118.2437 },
        zoom: 12
      });
    }

    var timeOut;
    function restartPeriodicUpdates() {
      handleInput(currentUser);
      timeOut = setTimeout(restartPeriodicUpdates, 1000);
    }

    function stopPeriodicUpdates() {
      clearTimeout(timeOut);
    }

    // TODO: Uncomment and add button for this!
    //renderStep();


    /*function postStuff() {
      let data = {};
      data.uniqueid ="Sahil";
      data.timestamp = 12124124238;
      data.longitude = -118.3437;
      data.latitude = 34.0562;
      //data = JSON.stringify(data);
      console.log(data);
      jQuery.ajax({
        url: '/api/newLoc',
        type:"POST",
        data: JSON.stringify(data),
        contentType:"application/json; charset=utf-8",
        success: function (resp) {
          console.log(resp);
        },
        error: function () {
          console.log("error");
        }
      });
    }*/

    var currentUser = '';

    function handleInput(elem) {
      var value = '';
      if (elem == '') {
        value = document.getElementById('pac-input').value;
      }
      else {
        value = currentUser;
      }
      var getStringValue = '/api/getLoc?uniqueid=' + value;
      currentUser = value;
      var jsonResp;

      $.ajax({
        url: getStringValue,
        async: false,
        dataType: 'json',
        success: function (resp) {
          jsonResp = resp;
        }
      });

      var count = jsonResp.length;
      if (count == 0) {
        alert("USER ID NOT FOUND!");
      } else {
        for (var i = 0; i < count; i++) {
          var latitude = Number(jsonResp[ i ].latitude);
          var longitude = Number(jsonResp[ i ].longitude);
          console.log(typeof (latitude));
          var location = { lat: longitude, lng: latitude };
          console.log(location);
          addMarker(location, map);

          var newLoc = { lat: 34.0562, lng: -118.0437 };
          addMarker(newLoc, map);
        }
      }
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[ i ].setMap(map);
      }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
      setMapOnAll(null);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
      clearMarkers();
      markers = [];
    }

    // Adds a marker to the map.
    function addMarker(location, map) {
      // Add the marker at the clicked location, and add the next-available label
      // from the array of alphabetical characters.
      var marker = new google.maps.Marker({
        position: location,
        // label: labels[labelIndex++ % labels.length],
        map: map
      });
      markers.push(marker);
    }

    function deleteAllData() {

    }


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNj-YsCIOTmbGfofgV6o4D8Ct39hVAbqI&callback=initMap" async
    defer></script>
</body>

</html>
